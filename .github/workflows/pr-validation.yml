name: PR Validation & Quality Checks (Reusable)

on:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  security-events: write
  actions: read

jobs:
  detect-changes:
    name: Detect PR change areas
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.filter.outputs.frontend }}
      backend_changed: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.js'
              - '**/*.jsx'
              - '**/*.css'
              - '**/*.scss'
              - '**/*.vue'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'yarn.lock'
              - 'package-lock.json'
              - 'tsconfig.json'
              - '**/vite.config.*'
              - '**/next.config.*'
              - '.eslintrc*'
              - '.prettierrc*'
              - 'prettier.config.*'
              - 'eslint.config.*'
            backend:
              - '**/*.java'
              - '**/*.xml'
              - '**/*.yml'
              - '**/*.yaml'
              - 'pom.xml'
              - '**/liquibase/**'
              - '**/db/**'
              - '**/migrations/**'

  validate-and-label:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 0Ô∏è‚É£ Fetch centralized config files (maximize reuse)
      - name: Fetch centralized labeler configs from .github repository
        uses: actions/checkout@v4
        with:
          repository: OpenResilienceInitiative/.github
          path: .github-central
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Use centralized config files (single source of truth)
        run: |
          SUMMARY_FILE="$GITHUB_STEP_SUMMARY"
          mkdir -p .github

          # Verify centralized repository checkout succeeded
          if [ ! -d .github-central ]; then
            {
              echo "‚ùå Failed to checkout centralized .github repository";
              echo "‚ùå Failed to checkout centralized .github repository";
            } >> "$SUMMARY_FILE"
            echo "‚ùå Failed to checkout centralized .github repository"
            exit 1
          fi

          # Copy pr-labeler.yml from centralized (NO local copies needed)
          if [ ! -f .github-central/pr-labeler.yml ]; then
            {
              echo "‚ùå **pr-labeler.yml**: Not found in centralized repository";
              echo "‚ùå pr-labeler.yml not found in OpenResilienceInitiative/.github";
            } >> "$SUMMARY_FILE"
            echo "‚ùå pr-labeler.yml not found in OpenResilienceInitiative/.github"
            exit 1
          fi
          cp .github-central/pr-labeler.yml .github/pr-labeler.yml

          # Copy size-labeler.yml from centralized (NO local copies needed)
          if [ ! -f .github-central/size-labeler.yml ]; then
            {
              echo "‚ùå **size-labeler.yml**: Not found in centralized repository";
              echo "‚ùå size-labeler.yml not found in OpenResilienceInitiative/.github";
            } >> "$SUMMARY_FILE"
            echo "‚ùå size-labeler.yml not found in OpenResilienceInitiative/.github"
            exit 1
          fi
          cp .github-central/size-labeler.yml .github/size-labeler.yml

          # Summary (use heredoc with single-quoted delimiter to avoid interpolation/backticks)
          cat <<'EOF' >> "$SUMMARY_FILE"
          ## üìã Config File Management (Centralized)

          ‚ú® **Single Source of Truth**: Config files are fetched from `OpenResilienceInitiative/.github`

          ‚úÖ **Config files ready for labeler actions**
             - `.github/pr-labeler.yml` (from centralized)
             - `.github/size-labeler.yml` (from centralized)

          ‚úÖ All config files fetched from centralized repository - no local copies needed!
          EOF

      # 1Ô∏è‚É£ Validate Semantic PR Title
      - name: Validate semantic PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            chore
            refactor
            docs
            ci
            perf
            test
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            must start with a lowercase letter.

      # 2Ô∏è‚É£ Validate PR Body Completeness
      - name: Validate PR body completeness
        uses: actions/github-script@v7
        id: validate-body
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Check for unchecked items
            const uncheckedItems = (body.match(/\[ \]/g) || []).length;
            
            // Check minimum body length (at least 100 chars excluding template placeholders)
            const minBodyLength = 100;
            const bodyWithoutPlaceholders = body
              .replace(/\[Link to doc\]\(https:\/\/\.\.\.\)/g, '')
              .replace(/\[Link\]\(https:\/\/\.\.\.\)/g, '')
              .replace(/https:\/\/\.\.\./g, '')
              .trim();
            
            const errors = [];
            
            if (uncheckedItems > 0) {
              errors.push(`‚ùå Found ${uncheckedItems} unchecked checklist item(s). Please complete all checklist items.`);
            }
            
            if (bodyWithoutPlaceholders.length < minBodyLength) {
              errors.push(`‚ùå PR description is too short (${bodyWithoutPlaceholders.length} chars). Please provide a detailed summary (minimum ${minBodyLength} chars).`);
            }
            
            // Check if "Summary" section exists and has content
            const summaryMatch = body.match(/Summary\s*\n+([\s\S]*?)(?=\n+##|\n+‚úÖ|$)/i);
            if (!summaryMatch || !summaryMatch[1] || summaryMatch[1].trim().length < 50) {
              errors.push('‚ùå Summary section appears incomplete. Please provide at least 50 characters of detailed information about what changed and why.');
            }
            
            if (errors.length > 0) {
              core.setFailed(errors.join('\n\n'));
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ‚ö†Ô∏è PR Validation Failed\n\n${errors.join('\n\n')}\n\nPlease update your PR description to meet the requirements.`
              });
            } else {
              console.log('‚úÖ PR body validation passed');
            }

      # 3Ô∏è‚É£ Auto Label Pull Requests (Work Type & Area)
      - name: Auto label PRs (branch-based)
        uses: TimonVS/pr-labeler-action@v4
        with:
          configuration-path: .github/pr-labeler.yml
          skip-draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4Ô∏è‚É£ File-based Area Label (only ONE area label)
      - name: Add area label based on files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const filePaths = files.data.map(f => f.filename);
            
            // Priority order: detect ONE area label
            let areaLabel = '';
            if (filePaths.some(f => ['.tsx', '.ts', '.jsx', '.js', '.css', '.scss', '.vue'].some(p => f.includes(p)))) areaLabel = 'frontend';
            else if (filePaths.some(f => ['/api/', '/routes/', '/controllers/'].some(p => f.includes(p)))) areaLabel = 'api';
            else if (filePaths.some(f => ['.java', '.py', '.go', '.rs', 'pom.xml', 'requirements.txt'].some(p => f.includes(p)))) areaLabel = 'backend';
            else if (filePaths.some(f => ['.sql', '/migrations/', '/schema/'].some(p => f.includes(p)))) areaLabel = 'database';
            else if (filePaths.some(f => ['.github/', 'Dockerfile', '/kubernetes/', '/terraform/'].some(p => f.includes(p)))) areaLabel = 'infra';
            else if (filePaths.some(f => ['.md', '/docs/', '/documentation/'].some(p => f.includes(p)))) areaLabel = 'docs';
            
            // Only add if detected (don't duplicate with branch-based)
            if (areaLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [areaLabel]
              });
            }
            
            // Priority: only if explicitly mentioned (not default)
            const title = (context.payload.pull_request.title || '').toLowerCase();
            const body = (context.payload.pull_request.body || '').toLowerCase();
            const priorityKeywords = {
              'P0-Critical': ['critical', 'urgent', 'p0', 'hotfix', 'production down', 'security', 'data loss'],
              'P1-High': ['high priority', 'p1', 'important', 'blocker', 'major'],
              'P2-Medium': ['medium', 'p2'],
              'P3-Low': ['low', 'p3', 'nice to have']
            };
            
            for (const [priority, keywords] of Object.entries(priorityKeywords)) {
              if (keywords.some(k => title.includes(k) || body.includes(k))) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [priority]
                });
                break;
              }
            }
            
            // Special labels: breaking change, state
            if (['breaking', 'breaking change', '!:', '‚ö†Ô∏è'].some(k => title.includes(k) || body.includes(k))) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['breaking-change']
              });
            }
            
            if (['wip', 'draft', '[wip]', '[draft]'].some(k => title.includes(k))) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['needs-refinement']
              });
            }

      # 5Ô∏è‚É£ Size Label Based on File Count
      - name: Auto-size label based on file count
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const fileCount = files.data.length;
            let sizeLabel = '';
            
            if (fileCount >= 100) sizeLabel = 'XL';
            else if (fileCount >= 30) sizeLabel = 'L';
            else if (fileCount >= 10) sizeLabel = 'M';
            else if (fileCount >= 1) sizeLabel = 'S';
            
            if (sizeLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [sizeLabel]
              });
            }

      # 6Ô∏è‚É£ Security Scan
      - name: Run Trivy vulnerability scanner
        id: trivy-scan
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities (we upload results anyway)

      - name: Check if SARIF file exists
        id: check-sarif
        run: |
          if [ -f "trivy-results.sarif" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.check-sarif.outputs.exists == 'true'
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      # 7Ô∏è‚É£ Code Quality Checks
      - name: Check for TODO/FIXME comments
        run: |
          echo "## üîç Code Quality Check Results" >> "$GITHUB_STEP_SUMMARY"
          if grep -r "TODO\|FIXME" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.java" --include="*.py" "." 2>/dev/null | grep -v "node_modules" | grep -v ".git" | head -10; then
            echo "‚ö†Ô∏è **Warning:** Found TODO/FIXME comments. Please address or document them." >> "$GITHUB_STEP_SUMMARY"
            echo "‚ö†Ô∏è Found TODO/FIXME comments. Please address or document them."
            exit 0  # Warning, not blocking
          else
            echo "‚úÖ No TODO/FIXME comments found." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Check for console.log (non-test files)
        run: |
          echo "## üîç Console.log Check Results" >> "$GITHUB_STEP_SUMMARY"
          if grep -r "console\\.log" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" "." 2>/dev/null | grep -v "node_modules" | grep -v ".git" | grep -v "test" | grep -v "spec" | grep -v "__tests__"; then
            echo "‚ö†Ô∏è **Warning:** Found console.log statements. Please remove before merging." >> "$GITHUB_STEP_SUMMARY"
            echo "‚ö†Ô∏è Found console.log statements. Please remove before merging."
            exit 0  # Warning, not blocking
          else
            echo "‚úÖ No console.log statements found (excluding test files)." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Check for hardcoded secrets patterns
        run: |
          echo "## üîç Security Pattern Check" >> "$GITHUB_STEP_SUMMARY"
          SECRET_PATTERNS="password|secret|api_key|apikey|access_token|private_key|PRIVATE_KEY"
          if grep -riE "$SECRET_PATTERNS" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.java" --include="*.py" "." 2>/dev/null | grep -v "node_modules" | grep -v ".git" | grep -v "test" | grep -v "spec" | grep -v "package-lock.json" | grep -v "yarn.lock"; then
            echo "‚ö†Ô∏è **Warning:** Potential hardcoded secrets detected. Please review and use environment variables or secrets management." >> "$GITHUB_STEP_SUMMARY"
            echo "‚ö†Ô∏è Potential hardcoded secrets detected. Please review."
            exit 0  # Warning, not blocking
          else
            echo "‚úÖ No obvious hardcoded secrets patterns found." >> "$GITHUB_STEP_SUMMARY"
          fi

  frontend-standards:
    name: Frontend Standards (ESLint, Prettier, Node 18.16.1)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.frontend_changed == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 18.16.1
        uses: actions/setup-node@v4
        with:
          node-version: '18.16.1'
          cache: 'npm'

      - name: Install dependencies (auto-detect)
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            corepack enable
            pnpm i --frozen-lockfile
          elif [ -f "yarn.lock" ]; then
            corepack enable
            yarn install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci --include=dev
          else
            npm install --include=dev
          fi

      - name: Verify ESLint (Airbnb + TypeScript)
        run: |
          echo "## ‚úÖ ESLint Check (Airbnb + TS)" >> "$GITHUB_STEP_SUMMARY"
          npx --yes eslint "src/**/*.{ts,tsx,js,jsx}" || { echo "‚ùå ESLint failed" >> "$GITHUB_STEP_SUMMARY"; exit 1; }

      - name: Verify Prettier formatting (4 spaces, semicolons, single quotes, 120 width)
        run: |
          echo "## ‚úÖ Prettier Check" >> "$GITHUB_STEP_SUMMARY"
          npx --yes prettier --check "." \
            --tab-width 4 \
            --single-quote \
            --print-width 120 \
            --no-error-on-unmatched-pattern \
            --semi || { echo "‚ùå Prettier formatting mismatch" >> "$GITHUB_STEP_SUMMARY"; exit 1; }

      - name: TypeScript compile (no emit)
        run: |
          if [ -f "tsconfig.json" ]; then
            echo "## ‚úÖ TypeScript Compile Check" >> "$GITHUB_STEP_SUMMARY"
            npx --yes tsc --noEmit
          else
            echo "‚ÑπÔ∏è tsconfig.json not found, skipping TS compile check" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Optional chaining and .catch usage heuristic
        run: |
          echo "## üîç Heuristic Checks" >> "$GITHUB_STEP_SUMMARY"
          # Heuristic: count potential fetch/axios calls lacking .catch (non-blocking)
          if grep -R "\\bfetch\\(|\\baxios\\." "src" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | grep -v "node_modules" >/dev/null; then
            MISSING_CATCH_COUNT=$(grep -R "\\b(fetch\\(|axios\\.[a-z][a-z0-9_]*\\()" "src" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null \
              | grep -vE "\\.catch\\(|[[:space:]]*try[[:space:]]*\\{" \
              | grep -vc '^$' || true)
            echo "‚ÑπÔ∏è Heuristic only: ensure API calls are handled with .catch or try/catch (found $MISSING_CATCH_COUNT potential occurrences)." >> "$GITHUB_STEP_SUMMARY"
          fi
          exit 0

      - name: Cypress (if configured)
        id: detect-scripts
        run: |
          HAS_CYPRESS=$(node -e "try{const p=require('./package.json');console.log(Boolean((p.devDependencies&&p.devDependencies.cypress)||(p.dependencies&&p.dependencies.cypress)))}catch(e){console.log(false)}")
          HAS_E2E=$(node -e "try{const p=require('./package.json');console.log(Boolean(p.scripts&&p.scripts['test:e2e']))}catch(e){console.log(false)}")
          echo "has_cypress=$HAS_CYPRESS" >> "$GITHUB_OUTPUT"
          echo "has_e2e=$HAS_E2E" >> "$GITHUB_OUTPUT"

      - name: Run Cypress tests
        if: ${{ steps.detect-scripts.outputs.has_cypress == 'true' && steps.detect-scripts.outputs.has_e2e == 'true' }}
        uses: cypress-io/github-action@v6
        with:
          command: npm run test:e2e
          install: false

  backend-standards:
    name: Backend Standards (Java 17 + Spring Boot Maven)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.backend_changed == 'true' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build and test with Maven
        run: |
          mvn -B -ntp -DskipTests=false verify

      - name: Liquibase validate (if configured)
        run: |
          echo "## üîç Liquibase Validate (best-effort)" >> "$GITHUB_STEP_SUMMARY"
          if grep -R "liquibase-maven-plugin" -n "." 2>/dev/null; then
            mvn -B -ntp liquibase:validate || { echo "‚ö†Ô∏è Liquibase validate failed. Please check migrations." >> "$GITHUB_STEP_SUMMARY"; exit 1; }
          else
            echo "‚ÑπÔ∏è Liquibase plugin not detected. Skipping." >> "$GITHUB_STEP_SUMMARY"
          fi