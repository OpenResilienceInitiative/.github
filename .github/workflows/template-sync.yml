name: Sync PR and Issue Templates (Reusable)

on:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-templates:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 0ï¸âƒ£ Sync PR and Issue templates from .github repository
      - name: Sync templates from .github
        id: sync
        run: |
          # Detect default branch (main or master)
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            DEFAULT_BRANCH="main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            DEFAULT_BRANCH="master"
          else
            DEFAULT_BRANCH="main"  # Fallback
          fi
          
          # Switch to default branch
          git checkout "$DEFAULT_BRANCH" 2>/dev/null || git checkout -b "$DEFAULT_BRANCH"
          echo "default_branch=$DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"
          
          # Create sync branch
          SYNC_BRANCH="chore/sync-templates-$(date +%s)"
          git checkout -b "$SYNC_BRANCH"
          echo "sync_branch=$SYNC_BRANCH" >> "$GITHUB_OUTPUT"
          
          # Add .github as remote and fetch
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "https://github.com/OpenResilienceInitiative/.github.git"
          git fetch upstream main --quiet
          
          # Sync only PR and Issue templates from .github repo root
          # Create .github directory if it doesn't exist
          mkdir -p .github
          
          # Sync Issue templates (from root of .github repo)
          git checkout "upstream/main" -- ISSUE_TEMPLATE 2>/dev/null || true
          if [ -d "ISSUE_TEMPLATE" ]; then
            rm -rf .github/ISSUE_TEMPLATE 2>/dev/null || true
            mv ISSUE_TEMPLATE .github/ISSUE_TEMPLATE 2>/dev/null || true
          fi
          
          # Sync PR templates (from root of .github repo)
          git checkout "upstream/main" -- PULL_REQUEST_TEMPLATE PULL_REQUEST_TEMPLATE.md 2>/dev/null || true
          if [ -d "PULL_REQUEST_TEMPLATE" ]; then
            rm -rf .github/PULL_REQUEST_TEMPLATE 2>/dev/null || true
            mv PULL_REQUEST_TEMPLATE .github/PULL_REQUEST_TEMPLATE 2>/dev/null || true
          fi
          if [ -f "PULL_REQUEST_TEMPLATE.md" ]; then
            cp PULL_REQUEST_TEMPLATE.md .github/PULL_REQUEST_TEMPLATE.md 2>/dev/null || true
          fi
          
          # Commit if changes exist
          if ! git diff --quiet && ! git diff --cached --quiet; then
            git add .
            git commit -m "chore: Sync PR and Issue templates from template repository"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Push branch
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          git push -u origin "${{ steps.sync.outputs.sync_branch }}"

      - name: Create PR
        if: steps.sync.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const syncBranch = '${{ steps.sync.outputs.sync_branch }}';
            
            const defaultBranch = '${{ steps.sync.outputs.default_branch }}';
            
            // Check if PR already exists
            const { data: existing } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${syncBranch}`,
              base: defaultBranch
            });
            
            if (existing.length > 0) {
              console.log(`PR already exists: ${existing[0].html_url}`);
              return;
            }
            
            // Create PR
            const prBody = [
              '## ðŸ”„ Template Sync',
              '',
              'This PR syncs PR and Issue templates from `OpenResilienceInitiative/.github`.',
              '',
              '**Synced:**',
              '- `.github/PULL_REQUEST_TEMPLATE/`',
              '- `.github/ISSUE_TEMPLATE/`',
              '- `PULL_REQUEST_TEMPLATE.md`',
              '',
              '*Automated by template sync workflow.*'
            ].join('\n');
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'chore: Sync PR and Issue templates from template repository',
              head: syncBranch,
              base: defaultBranch,
              body: prBody,
              maintainer_can_modify: true
            });
            
            console.log(`âœ… PR created: ${pr.html_url}`);

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.sync.outputs.has_changes }}" = "true" ]; then
            echo "âœ… Templates synced and PR created" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âœ… Templates are up to date" >> "$GITHUB_STEP_SUMMARY"
          fi
